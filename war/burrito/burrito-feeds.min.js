function BurritoPollingChannel(c,a,d){var b=this;this.pollingIntervalSeconds=45;this.subscriptionId=c;this.currentTimeout=-1;this.feedServer=a;this.onMessage=d;this.startPolling=function(){b.triggerNewPoll()};this.onMessages=function(g){if(!g.messages){return}for(var f=0;f<g.messages.length;f++){var e=g.messages[f];b.onMessage(e)}};this.doPoll=function(){$.ajax({url:b.feedServer+"/burrito/feeds/subscription/"+b.subscriptionId+"/poll",dataType:"jsonp",crossDomain:true,success:function(e){if(e.status=="error"){throw ("Error response from feed server: "+e.message)}b.onMessages(e)}})};this.triggerNewPoll=function(){b.currentTimeout=setTimeout(function(){b.doPoll();b.triggerNewPoll()},b.pollingIntervalSeconds*1000)}}function BurritoFeeds(){var object=this;this.pendingHandlers=new Array();this.registeredHandlers=new Array();this.feedServer="";this.method="push";this.channelId="";this.channelOpen=false;this.subscriptionId=-1;this.subscriptionRequestSent=false;this.channelOpenCallback=function(){};this.channelErrorCallback=function(){};this.channelRestartCallback=function(){};this.onChannelOpen=function(func){this.channelOpenCallback=func};this.onChannelError=function(func){this.channelErrorCallback=func};this.onChannelRestart=function(func){this.channelRestartCallback=func};this.registerHandler=function(feedId,onMessageReceived,onStarted){var handler={onMessageReceived:onMessageReceived,onStarted:onStarted};if(object.subscriptionId<0){object.pendingHandlers[feedId]=handler;if(!object.subscriptionRequestSent){object.subscriptionRequestSent=true;object.getSubscriptionAndOpenChannel()}}else{object.registeredHandlers[feedId]=handler;object.addFeedToSubscription(feedId,handler)}};this.addFeedToSubscription=function(feedId,handler){if(object.addFeedToSubscriptionLock){setTimeout(function(){object.addFeedToSubscription(feedId,handler)},200)}else{object.addFeedToSubscriptionLock=true;$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/addFeed/"+encodeURIComponent(feedId),crossDomain:true,dataType:"jsonp",success:function(json){object.addFeedToSubscriptionLock=false;if(json.status=="error"){throw ("Error response from feed server: "+json.message)}if(object.channelOpen){var onStarted=handler.onStarted;if(onStarted){handler.onStarted=null;onStarted()}}}})}};this.setFeedServer=function(chServer){object.feedServer=chServer};this.setMethod=function(mthd){if(typeof(goog)=="undefined"){object.method="poll"}else{object.method=mthd}};this.getSubscriptionAndOpenChannel=function(){var url=object.feedServer+"/burrito/feeds/subscription/new/"+encodeURIComponent(object.method);if(object.method=="push"){var channelId=object.getCookie("burrito_unloadedChannelId");if(channelId){object.deleteCookie("burrito_unloadedChannelId");url+="/"+encodeURIComponent(channelId)}}$.ajax({url:url,dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message)}object.subscriptionId=json.subscriptionId;object.triggerNewKeepAlive();for(var feedId in object.pendingHandlers){var handler=object.pendingHandlers[feedId];if(handler){object.pendingHandlers[feedId]=null;object.registerHandler(feedId,handler.onMessageReceived,handler.onStarted)}}object.startListeningToChannel(json.channelId)}})};this.getNewChannel=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/newChannel",dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message);object.channelRestartCallback(false)}object.channelRestartCallback(true);object.startListeningToChannel(json.channelId)}})};this.dropChannel=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/dropChannel",dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message)}object.startListeningToChannel(null)}})};this.startListeningToChannel=function(channelId){object.channelId=channelId;if(channelId){if(!object.unloadHandlerAttached){object.unloadHandlerAttached=true;$(window).unload(function(){if(object.channelId){object.setCookie("burrito_unloadedChannelId",object.channelId,5*60*60*1000)}})}object.openGoogleChannel()}else{object.openPollingChannel()}};this.handleChannelOpen=function(){object.channelOpen=true;object.channelOpenCallback();for(var feedId in object.registeredHandlers){var handler=object.registeredHandlers[feedId];var onStarted=handler.onStarted;if(onStarted){handler.onStarted=null;onStarted()}}};this.onMessageReceived=function(json){var handler=object.registeredHandlers[json.feedId];if(handler){var onMessageReceived=handler.onMessageReceived;onMessageReceived(json.message)}};this.openPollingChannel=function(){var pollingChannel=new BurritoPollingChannel(object.subscriptionId,object.feedServer,function(json){object.onMessageReceived(json)});object.handleChannelOpen();pollingChannel.startPolling()};this.openGoogleChannel=function(){var lastChannelRetryTime=0;var channel=new goog.appengine.Channel(object.channelId);var socket=channel.open();socket.onopen=function(){object.handleChannelOpen()};socket.onclose=function(evt){if((new Date().getTime())-lastChannelRetryTime<5*60*1000){object.dropChannel()}else{lastChannelRetryTime=new Date().getTime();object.getNewChannel()}};socket.onmessage=function(evt){var json=eval("("+evt.data+")");object.onMessageReceived(json)};socket.onerror=function(error){object.channelErrorCallback(error)}};this.keepAlive=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/keepAlive",crossDomain:true,dataType:"jsonp"});object.triggerNewKeepAlive()};this.triggerNewKeepAlive=function(){setTimeout(function(){object.keepAlive()},180000)};this.getSubscriptionId=function(){return object.subscriptionId};this.setCookie=function(name,value,expireInMillis){var c=name+"="+value;if(expireInMillis){var date=new Date();date.setTime(date.getTime()+expireInMillis);c+="; expires="+date.toGMTString()}document.cookie=c+"; path=/"};this.deleteCookie=function(name){object.setCookie(name,"",-60*60*1000)};this.getCookie=function(name){name+="=";var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var c=$.trim(cookies[i]);if(c.indexOf(name)==0){return c.substring(name.length)}}return null}}var burritoFeeds=new BurritoFeeds();