/**
 * Copyright 2011 Henric Persson (henric.persson@gmail.com)
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
function BurritoPollingChannel(c,a,d){var b=this;this.pollingIntervalSeconds=45;this.subscriptionId=c;this.currentTimeout=-1;this.feedServer=a;this.onMessage=d;this.startPolling=function(){b.triggerNewPoll()};this.onMessages=function(g){if(!g.messages){return}for(var f=0;f<g.messages.length;f++){var e=g.messages[f];b.onMessage(e)}};this.doPoll=function(){$.ajax({url:b.feedServer+"/burrito/feeds/subscription/"+b.subscriptionId+"/poll",dataType:"jsonp",crossDomain:true,success:function(e){if(e.status=="error"){throw ("Error response from feed server: "+e.message)}b.onMessages(e)}})};this.triggerNewPoll=function(){b.currentTimeout=setTimeout(function(){b.doPoll();b.triggerNewPoll()},b.pollingIntervalSeconds*1000)}}function BurritoFeeds(){var object=this;this.pendingHandlers=new Array();this.registeredHandlers=new Array();this.feedServer="";this.method="push";this.channelId="";this.channelOpen=false;this.subscriptionId=-1;this.subscriptionRequestSent=false;this.channelOpenCallback=function(){};this.channelErrorCallback=function(){};this.channelRestartCallback=function(){};this.onChannelOpen=function(func){this.channelOpenCallback=func};this.onChannelError=function(func){this.channelErrorCallback=func};this.onChannelRestart=function(func){this.channelRestartCallback=func};this.registerHandler=function(feedId,onMessageReceived,onStarted){var handler={onMessageReceived:onMessageReceived,onStarted:onStarted};if(object.subscriptionId<0){object.pendingHandlers[feedId]=handler;if(!object.subscriptionRequestSent){object.subscriptionRequestSent=true;object.getSubscriptionAndOpenChannel()}}else{object.registeredHandlers[feedId]=handler;object.addFeedToSubscription(feedId,handler)}};this.addFeedToSubscription=function(feedId,handler){if(object.addFeedToSubscriptionLock){setTimeout(function(){object.addFeedToSubscription(feedId,handler)},200)}else{object.addFeedToSubscriptionLock=true;$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/addFeed/"+encodeURIComponent(feedId),crossDomain:true,dataType:"jsonp",success:function(json){object.addFeedToSubscriptionLock=false;if(json.status=="error"){throw ("Error response from feed server: "+json.message)}if(object.channelOpen){var onStarted=handler.onStarted;if(onStarted){handler.onStarted=null;onStarted()}}}})}};this.setFeedServer=function(chServer){object.feedServer=chServer};this.setMethod=function(mthd){if(typeof(goog)=="undefined"){object.method="poll"}else{object.method=mthd}};this.getSubscriptionAndOpenChannel=function(){var url=object.feedServer+"/burrito/feeds/subscription/new/"+encodeURIComponent(object.method);if(object.method=="push"){var channelId=object.getCookie("burrito_unloadedChannelId");if(channelId){object.deleteCookie("burrito_unloadedChannelId");url+="/"+encodeURIComponent(channelId)}}$.ajax({url:url,dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message)}object.subscriptionId=json.subscriptionId;object.triggerNewKeepAlive();for(var feedId in object.pendingHandlers){var handler=object.pendingHandlers[feedId];if(handler){object.pendingHandlers[feedId]=null;object.registerHandler(feedId,handler.onMessageReceived,handler.onStarted)}}object.startListeningToChannel(json.channelId)}})};this.getNewChannel=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/newChannel",dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message);object.channelRestartCallback(false)}object.channelRestartCallback(true);object.startListeningToChannel(json.channelId)}})};this.dropChannel=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/dropChannel",dataType:"jsonp",crossDomain:true,success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message)}object.startListeningToChannel(null)}})};this.startListeningToChannel=function(channelId){object.channelId=channelId;if(channelId){if(!object.unloadHandlerAttached){object.unloadHandlerAttached=true;$(window).unload(function(){if(object.channelId){object.setCookie("burrito_unloadedChannelId",object.channelId,5*60*60*1000)}})}object.openGoogleChannel()}else{object.openPollingChannel()}};this.handleChannelOpen=function(){object.channelOpen=true;object.channelOpenCallback();for(var feedId in object.registeredHandlers){var handler=object.registeredHandlers[feedId];var onStarted=handler.onStarted;if(onStarted){handler.onStarted=null;onStarted()}}};this.onMessageReceived=function(json){var handler=object.registeredHandlers[json.feedId];if(handler){var onMessageReceived=handler.onMessageReceived;onMessageReceived(json.message)}};this.openPollingChannel=function(){var pollingChannel=new BurritoPollingChannel(object.subscriptionId,object.feedServer,function(json){object.onMessageReceived(json)});object.handleChannelOpen();pollingChannel.startPolling()};this.openGoogleChannel=function(){var lastChannelRetryTime=0;var channel=new goog.appengine.Channel(object.channelId);var socket=channel.open();socket.onopen=function(){object.handleChannelOpen()};socket.onclose=function(evt){if((new Date().getTime())-lastChannelRetryTime<5*60*1000){object.dropChannel()}else{lastChannelRetryTime=new Date().getTime();object.getNewChannel()}};socket.onmessage=function(evt){var json=eval("("+evt.data+")");object.onMessageReceived(json)};socket.onerror=function(error){object.channelErrorCallback(error)}};this.keepAlive=function(){$.ajax({url:object.feedServer+"/burrito/feeds/subscription/"+object.subscriptionId+"/keepAlive",crossDomain:true,dataType:"jsonp"});object.triggerNewKeepAlive()};this.triggerNewKeepAlive=function(){setTimeout(function(){object.keepAlive()},180000)};this.getSubscriptionId=function(){return object.subscriptionId};this.setCookie=function(name,value,expireInMillis){var c=name+"="+value;if(expireInMillis){var date=new Date();date.setTime(date.getTime()+expireInMillis);c+="; expires="+date.toGMTString()}document.cookie=c+"; path=/"};this.deleteCookie=function(name){object.setCookie(name,"",-60*60*1000)};this.getCookie=function(name){name+="=";var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var c=$.trim(cookies[i]);if(c.indexOf(name)==0){return c.substring(name.length)}}return null}}var burritoFeeds=new BurritoFeeds();
function BurritoUtils(){var a=this;a.didRunOnceIdentifiers=new Array();a.jsFilesLoaded=new Array();a.jsFilesStartedLoading=new Array();a.jsFilesPendingCallbacks=new Array();this.runOnce=function(b,c){if(!a.didRunOnceIdentifiers[b]){a.didRunOnceIdentifiers[b]=true;c()}};this.runWithJavascriptFile=function(c,d){if(a.jsFilesLoaded[c]){d()}else{var b=a.jsFilesPendingCallbacks[c];if(!b){b=new Array();a.jsFilesPendingCallbacks[c]=b}b.push(d);if(!a.jsFilesStartedLoading[c]){a.jsFilesStartedLoading[c]=true;$.ajax({url:c,dataType:"script",cache:true,success:function(){a.jsFilesLoaded[c]=true;for(var e=0;e<b.length;e++){b[e]()}}})}}};this.getClassValue=function(e,f){var d=e.attr("class");if(d){d=d.split(" ");for(var b=0;b<d.length;b++){var g=d[b];if(g.length>=f.length&&g.substring(0,f.length)==f){return g.substring(f.length)}}}return null}}var burritoUtils=new BurritoUtils();function BurritoSitelets(){var self=this;var adminControlsClass="sitelet-admin-controls";self.onNewSiteletContentCallbacks=new Array();this.registerLiveBox=function(siteIdentifier,boxId){burritoFeeds.registerHandler("burrito:sitelet-box:"+siteIdentifier+"|"+boxId,function(message){self.handleIncomingUpdate(boxId,eval("("+message+")"))})};this.handleIncomingUpdate=function(boxId,update){var sitelets=update.sitelets;var box=$("#sitelet-box-"+boxId);box.find(".sitelet").each(function(){var id=burritoUtils.getClassValue($(this),"sitelet-properties-id-");for(var i=0;i<sitelets.length;i++){if(id==sitelets[i].id){return}}$(this).removeClass("sitelet");$(this).slideUp(500,function(){$(this).remove()})});var previousWrapper=null;for(var i=0;i<sitelets.length;i++){var sitelet=sitelets[i];var idClassName="sitelet-properties-id-"+sitelet.id;var siteletWrapper=box.find(".sitelet."+idClassName);if(siteletWrapper.length){self.placeSiteletWrapper(box,previousWrapper,siteletWrapper,idClassName)}if(sitelet.html){var hasNewContent;if(siteletWrapper.length){var existingVersion=burritoUtils.getClassValue(siteletWrapper,"sitelet-version-");hasNewContent=sitelet.version>existingVersion;if(hasNewContent){siteletWrapper.removeClass("sitelet-version-"+existingVersion);siteletWrapper.addClass("sitelet-version-"+sitelet.version);if(sitelet.js){eval("var siteletUpdateFunc = ("+sitelet.js+");");siteletUpdateFunc(siteletWrapper)}else{siteletWrapper.html(sitelet.html)}}}else{hasNewContent=true;siteletWrapper='<div style="display: none" class="sitelet '+idClassName+" sitelet-version-"+sitelet.version+'">'+sitelet.html+"</div>";self.placeSiteletWrapper(box,previousWrapper,siteletWrapper,idClassName);siteletWrapper=box.find(".sitelet."+idClassName);siteletWrapper.slideDown(500)}if(hasNewContent){for(var j=0;j<self.onNewSiteletContentCallbacks.length;j++){var callback=self.onNewSiteletContentCallbacks[j];callback(siteletWrapper)}}}else{if(!siteletWrapper.length||sitelet.version>burritoUtils.getClassValue(siteletWrapper,"sitelet-version-")){if(!self.boxPollTimeout){self.boxPollTimeout=setTimeout(function(){self.boxPollTimeout=false;$.ajax({url:"/burrito/sitelets/box/"+boxId+"/poll",dataType:"jsonp",success:function(json){if(json.status=="error"){throw ("Error response from feed server: "+json.message)}self.handleIncomingUpdate(boxId,json)}})},100+Math.floor(60*1000*Math.random()))}}}previousWrapper=siteletWrapper}};this.placeSiteletWrapper=function(box,previousWrapper,siteletWrapper,idClassName){if(previousWrapper){if(!previousWrapper.nextAll(".sitelet:first").hasClass(idClassName)){previousWrapper.after(siteletWrapper)}}else{if(!box.children(".sitelet:first").hasClass(idClassName)){box.prepend(siteletWrapper)}}};this.refreshSitelet=function(siteletPropertiesId){$.ajax({type:"POST",url:"/burrito/sitelets/refresh/"+siteletPropertiesId,data:{force:true}})};this.onNewSiteletContent=function(callback){self.onNewSiteletContentCallbacks.push(callback)};this.enableAdminControls=function(){$("."+adminControlsClass).live("click",function(){var siteletPropertiesId=burritoUtils.getClassValue($(this),"sitelet-properties-id-");$(this).fadeOut(function(){$(this).fadeIn()});self.refreshSitelet(siteletPropertiesId)});$(".sitelet").live("mouseover mouseout",function(event){if(event.type=="mouseover"){if(!self.adminControlsTimeout){var siteletPropertiesId=burritoUtils.getClassValue($(this),"sitelet-properties-id-");if(!$("."+adminControlsClass+".sitelet-properties-id-"+siteletPropertiesId).length){var offset=$(this).offset();self.adminControlsTimeout=setTimeout(function(){$("."+adminControlsClass).remove();$("body").append('<div class="'+adminControlsClass+" sitelet-properties-id-"+siteletPropertiesId+'" style="top: '+offset.top+"px; left: "+offset.left+'px; position: absolute">Refresh</div>');self.adminControlsTimeout=false},1000)}}}else{if(self.adminControlsTimeout){clearTimeout(self.adminControlsTimeout);self.adminControlsTimeout=false}}});$("."+adminControlsClass).live("mouseout",function(){$(this).remove()})};this.runOnceForSiteletVersion=function(siteletElement,callback){siteletElement=siteletElement.closest(".sitelet");burritoUtils.runOnce("burrito-sitelet-"+burritoUtils.getClassValue(siteletElement,"sitelet-properties-id-")+"-version-"+burritoUtils.getClassValue(siteletElement,"sitelet-version-"),callback)}}var burritoSitelets=new BurritoSitelets();
